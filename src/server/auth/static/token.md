# The Token Endpoint

The `/auth/token.html` page is built to return access tokens for a specific
user-app combination (your client application and whoever logs into the main
app once they get here). If the user is valid and your application's public key
is in the main application's database (along with its secret), this process
will return a cryptographically signed key.

By computing the signature using the same process that the server does, using
the same secret key that only the two of you share, you will be able to verify
that the contents of the token have not been altered. Since our app only
generates tokens for users who have a valid AWS Cognito login with our user
pool, we know that the access token you receive from this will have originally
been generated by a valid user.

To implement proper safeguards, what we would really need is expirey on our
tokens. We'll see how close we get to that...

## Use

From your app's client-side code, you first want to check if the user has a
valid access token (more on this below). If they do not, redirect them to this
page:

`<whatever-our-hosted-auth-site's-url-is>/auth/token.html?clientappkey=YOUR_PUBLIC_KEY&redirect=REDIRECT_BASE64_ENCODED`

If your public key is in the main app's database and the user logs into our app,
the app will generate a unique, signed access token using the user's unique
credentials and your app's secret.

Once this secret is generated, the main application will decode the `redirect`
query parameter to use as a redirect back to your application. Before performing
this redirect, it will encode the access token in base64, and append it to your
redirect URL via the `token` query parameter. It looks something like this:

```
https://www.google.com/?token=
eyJwdWJsaWNLZXkiOiJoYW5nbWFuIiwic2lnbmF0dXJlIjoiODgyY2MzOTBlODBmNzFmZTRlYzRmOTg
yZTczZjRjNjY5YjBhNzBmM2QzOTE5MzAwODZjZjJhYWRlNzFlOTkwYSIsIm1lc3NhZ2UiOnsidXVpZC
I6ImEwOTRmMTlmLWUwNmQtNDIyZC1iN2JjLWZlY2FhMTM3ZWNlMiIsImVtYWlsIjoicGMubHVuZGFha
GxAZ21haWwuY29tIn19
```

Whatever page you put in your initial redirect should be set up to do the
following:

1. Extract the token paramter from the query string and store it in your local or session storage (if it's present).
2. Ship the token with any requests you need to verify down to your application's server.

On your application's server, you should:

1. Decode the token from base64.
2. Verify that the token has not been tampered with by using your application's secret to hash the signature, and compare the results (your crypto library almost certainly provides a function for this).
3. (Not yet impelemented: Check the expirey time to make sure it hasn't expired. If it has, reject and have the user go authenticate again via the same redirect process)
4. Continue, knowing the person who originally generated that token matches the user ID encoded in the token (use the UUID as the 'BadgeBookId').

## Extracting token on Client Web Apps

```
const PUBLIC_KEY   = 'your-app-public-key';
const REDIRECT_URL = `http://localhost:8080/auth/token.html?clientappkey=${PUBLIC_KEY}`;

/*
 * Pull token from query params and reload
 */
(function extractTokenFromQueryParam() {
    let url = new URL(window.location);
    if (url.searchParams.has('token')) {
        let token = url.searchParams.get('token');
        window.sessionStorage.setItem('token', token);
        url.searchParams.delete('token');

        window.location = url.toLocaleString();
    }
})();


/*
 * Renew expired tokens by going back to BadgeBook.
 */
(function renewExpiredToken() {
    let token = window.sessionStorage.getItem('token');
    if (token && JSON.parse(atob(token.split('.')[1])).exp < Date.now()) {
        loginWithBadgeBook()
    }
})();


/*
 * Call to have the user log in with BadgeBook and return with an access token.
 */
function loginWithBadgeBook() {
    let currentUrl  = btoa(window.location);
    window.location = REDIRECT_URL + `&redirect=${currentUrl}`;
}


/*
 * Helper for grabbing the current token
 */
window.getToken = function() {
    return window.sessionStorage.getItem('token');
}
```